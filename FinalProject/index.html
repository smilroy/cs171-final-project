<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Adolescent AIDS</title>
    <!-- ADD Libraries-->
    <script src="libs/d3/d3.min.js" charset="utf-8"></script>
    <script src="libs/jquery/jquery-2.1.1.min.js" charset="utf-8"></script>
    <script src="libs/bootstrap/js/bootstrap.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script src="libs/colorbrewer.js"></script>

    <!--Stylesheets-->
    <link rel="stylesheet" type="text/css" href="libs/bootstrap/css/bootstrap.min.css">

    <!-- Project Stylesheet -->
    <link rel="stylesheet" type="text/css" href="css/myStyle.css">

    <!-- Project js -->
    <script src="js/map.js"></script>
    <script src="js/info.js"></script>
    <script src="js/country.js"></script>
    <script src="js/population.js"></script>
</head>
<body>
<div class="container">
     <h2>HIV epidemic in adolescents across the world</h2>
    <div class="row">

    </div>
    <div class="row">
        <div id="info" style="float:left;">
        </div>
    </div>
    <div class="row">
        <div class ="col-md-1">
            <div id="filter" style="float:left; width:200px;margin-top:5px;">
                <!-- <label>Show:</label> -->
                <input type="radio" name="filter" value="prevalence" checked>Prevalence
                <input type="radio" name="filter" value="deaths">Deaths
            </div>
            <div id="slider" style="width:300px;margin-top:5px;">
            </div>
            <div id="sliderinfo" style="width:300px;margin-top:5px;">
            </div>
        </div>
    </div>
    <div class="row">
        <div id="global-map" class ="col-md-8">
        </div>
        <div id="country" class ="col-md-3">
        </div>
    </div>
    <div class="row">
        <div id="trend_vis" class="col-map">
            Trend Visualization
        </div>
    </div>
</div>
    <script>
        $(function(){
            var map, info, country, total_prevalence, total_deaths, total_population_prevalence, total_population_deaths;
            var defaultYear = "2010";
            var world_data, aids_data;
            queue()
                    .defer(d3.json, 'data/world_data.json')
                    .defer(d3.csv, 'data/aids_data_20150419.csv')
                    .await(function (error, worldData, aidsData){
                        LoadData(error, worldData, aidsData);
                    });

            var LoadData = function(error, worldData, aidsData){
                if(!error)
                {
                    world_data = worldData;
                    aids_data = aidsData;
                    var data = AggregateAndFilter(defaultYear);
                   // Initialize Info Visualization
                    info = new Info(d3.select("#info"), defaultYear, total_prevalence, total_deaths, total_population_prevalence, total_population_deaths);
                    // Initialize Map Visualization
                    country = new Country(d3.select("#country"));
                     map = new Map(d3.select("#global-map"), data, aidsData, country);
                    population = new Population(d3.select("#country"), aidsData, defaultYear, "world");
                }
            }

            function AggregateAndFilter(selectedYear)
            {
                var adolescentData = aids_data.filter(function(d){
                    return (d.age_group_name == "10-14" || d.age_group_name == "15-19")
                            && d.sex_name == "Both sexes" && d.year == selectedYear; //&& d.metric == metric;
                })
                console.log("Filtered Data" + adolescentData);
                var worldData = world_data;
                // For each country iterate through adolescentData
                worldData.features.forEach(function (d){
                    var prevalence_count = 0;
                    var death_count = 0;
                    var count = 0;
                    adolescentData.forEach(function (a){
                        if(count >= 2) // Do not iterate over all the countries if already found 2 records for a country
                            return;
                        if(a.location_name == d.properties.name)
                        {
                            if(a.hiv_population_total != "NA")
                                prevalence_count = prevalence_count + parseFloat(a.hiv_population_total);
                            if(a.hiv_deaths_total != "NA")
                                death_count = death_count + parseFloat(a.hiv_deaths_total);
                            count++;
                        }
                    })
                    d.properties.aids_prevalence = d3.round(prevalence_count);
                    d.properties.aids_deaths = d3.round(death_count);
                })

                console.log("Filtered world data", worldData);
                console.log("Original world data", world_data);
                total_prevalence = d3.sum(worldData.features, function(d){return d.properties.aids_prevalence});
                total_deaths = d3.sum(worldData.features, function(d){return d.properties.aids_deaths});
                // Calculate aids prevalence and deaths in total population
                var all_population = aids_data.filter(function(d){
                    return(d.sex_name == "Both sexes" && d.year == selectedYear);
                })
                total_population_prevalence = d3.sum(all_population, function(d){
                    return d3.round(d.hiv_population_total);
                })
                total_population_deaths = d3.sum(all_population, function(d){
                    return d3.round(d.hiv_deaths_total);
                })
                console.log("Total Prevalence", total_prevalence);
                console.log("Total Deaths", total_deaths);
                console.log("Total Population Prevalence", total_population_prevalence);
                console.log("Total Population Deaths", total_population_deaths);
                return worldData;
            }
            /**** Add UI Events ****/
            d3.select("#filter").selectAll("input").on("click", function() {
                map.updateMetric(d3.select(this).node().value);
                info.updateMetric(d3.select(this).node().value);
            })
            d3.select("#slider").
                    append("input")
                    .attr("type", "range")
                    .attr("name", "points")
                    .attr("min", "1990")
                    .attr("max", "2010")
                    .attr("step", "1")
                    .attr("value", "2010");

            var g_slider = d3.select("#sliderinfo").append("svg").attr("width", 300).attr("height", 30).append("g");
            g_slider.append("text").attr("x", 0).attr("y", 10).text("1990").style("font-size", 12);
            g_slider.append("text").attr("x", 270).attr("y", 10).text("2010").style("font-size", 12);

            d3.select("#slider").select("input").on("input", function (d){
                var selectedYr = d3.select(this).node().value;
                var data = AggregateAndFilter(selectedYr);
                map.updateYear(selectedYr, data);
                info.updateYear(selectedYr, total_prevalence, total_deaths);
            })

        })
     </script>
</body>
</html>